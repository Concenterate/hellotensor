<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Imagination</title>
</head>
<body>
  <style media="screen">
    .bigwrap {
      background-color: #333;

      color: #fff;

      border-radius: 10px;
      /*border-style: solid;*/
      /*border-width: 1px;*/
      border-color: #000;
      padding: 10px;
      margin: 10px;

      text-align: center;
    }

    button {
      border-radius: 5px;
      background-color: #666;
      color: #eee;
      padding: 5px 12px 5px 12px;
      border-style: none;
    }

    a {
      color: #abf;
    }

    #images {
      display: block;
    }

    #img0, #img1 {
      display: block;
      border-radius: 7px;
      min-height: 256px;
      min-width: 256px;
    }

    .btnwrap {
      display: block;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .column{
      display: inline-block;
      text-align: center;
      margin: 10px;
    }
    #result {
      color: #ccc;
    }
    #notify {
      color:#aaa;
    }
  </style>

  <div class="bigwrap">
  <h1>Imagination</h1>
  <p>These two images were generated by a convolutional GAN network.</p>
  <div id="images">
    <div class="column">
      <img id="img0" src="" alt="">
      <div class="btnwrap">
        <button id='btn0' type="button" name="button" onclick="btn0()">This one better</button>
      </div>
    </div>
    <div class="column">
      <img id="img1" src="" alt="">
      <div class="btnwrap">
        <button id='btn1' type="button" name="button" onclick="btn1()">This one better</button>
      </div>
    </div>
  </div>
  <p>Which one do you prefer? Press the coresponding button.</p>
  <p id='result'></p>
  <p><button type="button" name="button" onclick="refresh()">Refresh</button></p>
  <p id='notify'></p>
  </div>

  <div class="bigwrap">
    <h3>Where do the images come from?</h3>
    <p>See <a
      href="https://ctmakro.github.io/site/on_learning/image/fast_lsgan.html"
      >here</a> for more details.</p>

    <p>Written by Qin Yongliang. Source available on <a href="https://github.com/ctmakro/hellotensor">GitHub</a></p>
  </div>


  <script type="text/javascript">
  //helper
  function geid(id){return document.getElementById(id);}
  function gv(id){return geid(id).value;}
  function ga(id,attr){return geid(id).getAttribute(attr);}
  function hset(id,content){geid(id).innerHTML=content;}
  function display(id){geid(id).style = 'display:inherit;'}

  function generalRequest(obj,opt,callback){
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange=function(){
      if (xhr.readyState==4)
      {
        try{
          var res;
          res = JSON.parse(xhr.responseText);
          if(xhr.status==0||xhr.status>=400)throw res;
          if(res.error)throw res;

          callback(null,res);
        }catch(err){
          callback(err);
        }
      }
    }

    try{
      xhr.open(opt.method,opt.url,true);
      xhr.setRequestHeader("Content-type","application/json");
      xhr.send(JSON.stringify(obj));
    }catch(err){
      callback(err);
    }
  }

  function API(method,url,obj){
    return new Promise(function(resolve,reject){
      generalRequest(obj,{
        method,
        url,
      },function(err,back){
        if(err)return reject(err);
        resolve(back);
      });
    })
  }

  //0. define placeholder
  var images = [null,null]

  //1. get two random images into their boxes
  var load = ()=>{
    //unblock the buttons
    geid('btn0').disabled = false
    geid('btn1').disabled = false

    //clear content
    hset('result','')

    return API('GET','random',{})
    .then(res=>{
      images[0]=res
      return API('GET','random',{})
    })
    .then(res=>{
      images[1]=res

      //kick start an animation
      var opacity = 0
      var si = setInterval(()=>{
        opacity+=.1
        if(opacity>=1){
          clearInterval(si)
        }
        geid('img0').style.opacity = opacity
        geid('img1').style.opacity = opacity
      },50)

      //transparentify
      geid('img0').style.opacity = 0
      geid('img1').style.opacity = 0

      //set the new images
      geid('img0').src = 'generated/' + images[0].id
      geid('img1').src = 'generated/' + images[1].id
    })
  }

  //2. respond on buttons
  var like = (which)=>{
    var i0 = images[0]
    var i1 = images[1]
    // block the buttons
    geid('btn0').disabled = true
    geid('btn1').disabled = true

    var scores = [1-which,which]

    // update scores
    API('GET','score/'+i0.id+'/'+scores[0].toString()+'/'+i0.key,{})
    .then(res=>{
      return API('GET','score/'+i1.id+'/'+scores[1].toString()+'/'+i1.key,{})
    })
    .then(res=>{
      //pull the scores
      return API('GET','score/'+i0.id,{})
    })
    .then(res=>{
      scores[0] = res
      return API('GET','score/'+i1.id,{})
    })
    .then(res=>{
      scores[1] = res
      // write the result
      var percentage = sc=>Math.floor(sc.p/(sc.p+sc.n)*100).toString()+'%'
      var conclusion = 'People prefer the first image '+ percentage(scores[0]) + ' of the time, the second image ' + percentage(scores[1]) + ' of the time.'

      hset('result',conclusion)
    })
    .catch(err=>{
      console.error(err);
      alert('An error occured. Try refresh the page')
    })
  }
  var btn0 = ()=>like(0)
  var btn1 = ()=>like(1)

  //3.refresh
  var refresh = ()=>{
    // location.reload()
    load()
  }

  load()
  </script>
</body>
</html>
